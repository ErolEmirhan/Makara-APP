<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#dc2626">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="MAKARA">
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" type="image/png" href="/patron.png">
  <link rel="apple-touch-icon" href="/patron.png">
  <title>MAKARA - Admin Dashboard</title>
  
  <!-- Firebase SDK (Compat Version) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  
  <script>
    // Firebase yapÄ±landÄ±rmasÄ±
    const firebaseConfig = {
      apiKey: "AIzaSyCdf-c13e0wCafRYHXhIls1epJgD1RjPUA",
      authDomain: "makara-16344.firebaseapp.com",
      projectId: "makara-16344",
      storageBucket: "makara-16344.firebasestorage.app",
      messagingSenderId: "216769654742",
      appId: "1:216769654742:web:16792742d4613f4269be77",
      measurementId: "G-K4XZHP11MM"
    };

    // Firebase'i baÅŸlat
    let app, db;
    let isAuthenticated = false;
    let realtimeUnsubscribe = null;
    let allSales = []; // TÃ¼m satÄ±ÅŸlarÄ± sakla
    let activeTab = 'reports'; // 'sales', 'reports', 'staff' - varsayÄ±lan: DetaylÄ± Raporlama
    let reportDateFilter = 'all'; // 'all', 'week', 'month'

    try {
      // Firebase zaten baÅŸlatÄ±lmÄ±ÅŸ mÄ± kontrol et
      try {
        app = firebase.app();
      } catch (e) {
        app = firebase.initializeApp(firebaseConfig);
      }
      db = firebase.firestore();
      console.log('âœ… Firebase baÅŸarÄ±yla baÅŸlatÄ±ldÄ±');
      document.getElementById('errorMessage')?.remove();
    } catch (error) {
      console.error('âŒ Firebase baÅŸlatma hatasÄ±:', error);
      const errorDiv = document.createElement('div');
      errorDiv.id = 'errorMessage';
      errorDiv.style.cssText = 'background: #ff4444; color: white; padding: 20px; text-align: center; margin: 20px; border-radius: 10px;';
      errorDiv.innerHTML = '<h3>âŒ Firebase SDK YÃ¼klenemedi</h3><p>LÃ¼tfen sayfayÄ± yenileyin veya internet baÄŸlantÄ±nÄ±zÄ± kontrol edin.</p>';
      document.body.insertBefore(errorDiv, document.body.firstChild);
    }

    // PIN giriÅŸi
    const adminPin = '1234';

    function showLogin() {
      const loginSection = document.getElementById('loginSection');
      const dashboard = document.getElementById('dashboard');
      if (loginSection) loginSection.style.display = 'block';
      if (dashboard) dashboard.style.display = 'none';
      if (realtimeUnsubscribe) {
        realtimeUnsubscribe();
        realtimeUnsubscribe = null;
      }
    }

    function showDashboard() {
      const loginSection = document.getElementById('loginSection');
      const dashboard = document.getElementById('dashboard');
      if (loginSection) loginSection.style.display = 'none';
      if (dashboard) dashboard.style.display = 'block';
      loadSales();
      startRealtimeListener();
    }

    function verifyPin() {
      const pinInput = document.getElementById('pinInput');
      if (!pinInput) return;
      
      const pin = pinInput.value;
      
      if (pin === adminPin) {
        isAuthenticated = true;
        sessionStorage.setItem('adminAuthenticated', 'true');
        showDashboard();
        pinInput.value = '';
      } else {
        alert('PIN hatalÄ±!');
        pinInput.value = '';
      }
    }

    // Sayfa yÃ¼klendiÄŸinde kontrol et
    window.addEventListener('load', () => {
      if (!db) {
        console.error('Firebase baÅŸlatÄ±lamadÄ±');
        return;
      }
      
      if (sessionStorage.getItem('adminAuthenticated') === 'true') {
        showDashboard();
      } else {
        showLogin();
      }
    });

    // SatÄ±ÅŸlarÄ± yÃ¼kle
    async function loadSales() {
      if (!db) {
        console.error('Firebase baÅŸlatÄ±lamadÄ±');
        return;
      }

      try {
        showLoading(true);
        const salesRef = db.collection('sales');
        
        // Ã–nce sale_date'e gÃ¶re sÄ±ralamayÄ± dene, yoksa timestamp'e gÃ¶re
        let query = salesRef;
        try {
          query = salesRef.orderBy('sale_date', 'desc').limit(1000);
        } catch (e) {
          try {
            query = salesRef.orderBy('created_at', 'desc').limit(1000);
          } catch (e2) {
            query = salesRef.limit(1000);
          }
        }
        
        const querySnapshot = await query.get();
        
        const sales = [];
        querySnapshot.forEach((doc) => {
          const data = doc.data();
          
          // Timestamp'i dÃ¶nÃ¼ÅŸtÃ¼r
          let saleDate = data.sale_date;
          let saleTime = data.sale_time;
          
          // EÄŸer sale_date yoksa, created_at veya timestamp'ten oluÅŸtur
          if (!saleDate && data.created_at) {
            const timestamp = data.created_at;
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp.seconds * 1000);
            saleDate = date.toLocaleDateString('tr-TR');
            saleTime = date.toLocaleTimeString('tr-TR');
          } else if (!saleDate && data.timestamp) {
            const timestamp = data.timestamp;
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp.seconds * 1000);
            saleDate = date.toLocaleDateString('tr-TR');
            saleTime = date.toLocaleTimeString('tr-TR');
          }
          
          // Items'Ä± parse et
          let items = [];
          let itemsArray = data.items_array || [];
          
          if (data.items) {
            if (Array.isArray(data.items)) {
              items = data.items;
            } else if (typeof data.items === 'string') {
              // String formatÄ±: "ÃœrÃ¼n AdÄ± x2, ÃœrÃ¼n AdÄ± 2 x3"
              items = data.items.split(', ').map(item => {
                const match = item.match(/(.+) x(\d+)/);
                if (match) {
                  return {
                    product_name: match[1].replace(' (Ä°KRAM)', ''),
                    quantity: parseInt(match[2]),
                    isGift: item.includes('(Ä°KRAM)')
                  };
                }
                return { product_name: item, quantity: 1, isGift: false };
              });
            }
          }
          
          sales.push({
            id: doc.id,
            sale_id: data.sale_id || doc.id,
            total_amount: data.total_amount || 0,
            payment_method: data.payment_method || 'Nakit',
            sale_date: saleDate || 'Bilinmeyen',
            sale_time: saleTime || '',
            staff_name: data.staff_name || null,
            table_name: data.table_name || null,
            table_type: data.table_type || null,
            items: items,
            items_array: itemsArray, // GerÃ§ek Firebase verileri
            itemsText: data.items || 'ÃœrÃ¼n bulunamadÄ±',
            isExpense: data.isExpense || false
          });
        });

        // Tarih + saate gÃ¶re sÄ±rala (en yeni satÄ±ÅŸ en Ã¼stte)
        sales.sort((a, b) => {
          if (a.sale_date && b.sale_date) {
            const [dayA, monthA, yearA] = a.sale_date.split('.');
            const [dayB, monthB, yearB] = b.sale_date.split('.');
            if (dayA && monthA && yearA && dayB && monthB && yearB) {
              const dateA = new Date(yearA, monthA - 1, dayA);
              const dateB = new Date(yearB, monthB - 1, dayB);
              
              if (a.sale_time) {
                const [hA, mA, sA] = a.sale_time.split(':');
                dateA.setHours(parseInt(hA) || 0, parseInt(mA) || 0, parseInt(sA) || 0, 0);
              }
              if (b.sale_time) {
                const [hB, mB, sB] = b.sale_time.split(':');
                dateB.setHours(parseInt(hB) || 0, parseInt(mB) || 0, parseInt(sB) || 0, 0);
              }
              
              const diff = dateB - dateA;
              if (diff !== 0) return diff;
            }
          }
          
          // Tarih/saat yoksa veya eÅŸitse, sale_id'ye gÃ¶re (bÃ¼yÃ¼kten kÃ¼Ã§Ã¼ÄŸe) sÄ±rala
          const idA = parseInt(a.sale_id) || 0;
          const idB = parseInt(b.sale_id) || 0;
          return idB - idA;
        });

        allSales = sales; // TÃ¼m satÄ±ÅŸlarÄ± sakla
        renderCurrentView();
        updateStats(sales);
        showLoading(false);
      } catch (error) {
        console.error('SatÄ±ÅŸ yÃ¼kleme hatasÄ±:', error);
        showLoading(false);
        const container = document.getElementById('salesContainer');
        if (container) {
          container.innerHTML = `
            <div class="error-card">
              <div class="error-icon">âš ï¸</div>
              <h3>BaÄŸlantÄ± HatasÄ±</h3>
              <p>${error.message || 'Firebase\'e baÄŸlanÄ±lamadÄ±'}</p>
              <button onclick="location.reload()" class="retry-btn">ğŸ”„ Yeniden Dene</button>
            </div>
          `;
        }
      }
    }

    // Real-time dinleme
    function startRealtimeListener() {
      if (!db) return;
      
      if (realtimeUnsubscribe) {
        realtimeUnsubscribe();
      }

      const salesRef = db.collection('sales');
      let query = salesRef;
      try {
        query = salesRef.orderBy('sale_date', 'desc').limit(1000);
      } catch (e) {
        try {
          query = salesRef.orderBy('created_at', 'desc').limit(1000);
        } catch (e2) {
          query = salesRef.limit(1000);
        }
      }
      
      realtimeUnsubscribe = query.onSnapshot((snapshot) => {
        const sales = [];
        snapshot.forEach((doc) => {
          const data = doc.data();
          
          let saleDate = data.sale_date;
          let saleTime = data.sale_time;
          
          if (!saleDate && data.created_at) {
            const timestamp = data.created_at;
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp.seconds * 1000);
            saleDate = date.toLocaleDateString('tr-TR');
            saleTime = date.toLocaleTimeString('tr-TR');
          } else if (!saleDate && data.timestamp) {
            const timestamp = data.timestamp;
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp.seconds * 1000);
            saleDate = date.toLocaleDateString('tr-TR');
            saleTime = date.toLocaleTimeString('tr-TR');
          }
          
          let items = [];
          let itemsArray = data.items_array || [];
          
          if (data.items) {
            if (Array.isArray(data.items)) {
              items = data.items;
            } else if (typeof data.items === 'string') {
              items = data.items.split(', ').map(item => {
                const match = item.match(/(.+) x(\d+)/);
                if (match) {
                  return {
                    product_name: match[1].replace(' (Ä°KRAM)', ''),
                    quantity: parseInt(match[2]),
                    isGift: item.includes('(Ä°KRAM)')
                  };
                }
                return { product_name: item, quantity: 1, isGift: false };
              });
            }
          }
          
          sales.push({
            id: doc.id,
            sale_id: data.sale_id || doc.id,
            total_amount: data.total_amount || 0,
            payment_method: data.payment_method || 'Nakit',
            sale_date: saleDate || 'Bilinmeyen',
            sale_time: saleTime || '',
            staff_name: data.staff_name || null,
            table_name: data.table_name || null,
            table_type: data.table_type || null,
            items: items,
            items_array: itemsArray, // GerÃ§ek Firebase verileri
            itemsText: data.items || 'ÃœrÃ¼n bulunamadÄ±',
            isExpense: data.isExpense || false
          });
        });

        sales.sort((a, b) => {
          if (a.sale_date && b.sale_date) {
            const [dayA, monthA, yearA] = a.sale_date.split('.');
            const [dayB, monthB, yearB] = b.sale_date.split('.');
            if (dayA && monthA && yearA && dayB && monthB && yearB) {
              const dateA = new Date(yearA, monthA - 1, dayA);
              const dateB = new Date(yearB, monthB - 1, dayB);
              
              if (a.sale_time) {
                const [hA, mA, sA] = a.sale_time.split(':');
                dateA.setHours(parseInt(hA) || 0, parseInt(mA) || 0, parseInt(sA) || 0, 0);
              }
              if (b.sale_time) {
                const [hB, mB, sB] = b.sale_time.split(':');
                dateB.setHours(parseInt(hB) || 0, parseInt(mB) || 0, parseInt(sB) || 0, 0);
              }
              
              const diff = dateB - dateA;
              if (diff !== 0) return diff;
            }
          }
          
          const idA = parseInt(a.sale_id) || 0;
          const idB = parseInt(b.sale_id) || 0;
          return idB - idA;
        });

        allSales = sales; // TÃ¼m satÄ±ÅŸlarÄ± sakla
        renderCurrentView();
        updateStats(sales);
      }, (error) => {
        console.error('Real-time listener hatasÄ±:', error);
      });
    }

    // Tarihi formatla
    function formatDateDisplay(dateStr) {
      if (!dateStr || dateStr === 'Bilinmeyen') return dateStr;
      const [day, month, year] = dateStr.split('.');
      if (!day || !month || !year) return dateStr;
      
      const date = new Date(year, month - 1, day);
      const days = ['Pazar', 'Pazartesi', 'SalÄ±', 'Ã‡arÅŸamba', 'PerÅŸembe', 'Cuma', 'Cumartesi'];
      const months = ['Ocak', 'Åubat', 'Mart', 'Nisan', 'MayÄ±s', 'Haziran', 'Temmuz', 'AÄŸustos', 'EylÃ¼l', 'Ekim', 'KasÄ±m', 'AralÄ±k'];
      
      const dayName = days[date.getDay()];
      const monthName = months[parseInt(month) - 1];
      
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const saleDate = new Date(year, month - 1, day);
      saleDate.setHours(0, 0, 0, 0);
      
      const yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);
      
      if (saleDate.getTime() === today.getTime()) {
        return `BugÃ¼n - ${day} ${monthName} ${year}`;
      } else if (saleDate.getTime() === yesterday.getTime()) {
        return `DÃ¼n - ${day} ${monthName} ${year}`;
      } else {
        return `${day} ${monthName} ${year} - ${dayName}`;
      }
    }

    // SatÄ±ÅŸlarÄ± render et
    function renderSales(sales) {
      const container = document.getElementById('salesContainer');
      if (!container) return;

      if (sales.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">ğŸ“Š</div>
            <h3>HenÃ¼z SatÄ±ÅŸ Yok</h3>
            <p>SatÄ±ÅŸ yapÄ±ldÄ±kÃ§a burada gÃ¶rÃ¼necek</p>
          </div>
        `;
        return;
      }

      // Tarihe gÃ¶re grupla
      const salesByDate = {};
      sales.forEach(sale => {
        const date = sale.sale_date || 'Bilinmeyen';
        if (!salesByDate[date]) {
          salesByDate[date] = [];
        }
        salesByDate[date].push(sale);
      });

      // Tarihleri sÄ±rala
      const sortedDates = Object.keys(salesByDate).sort((a, b) => {
        if (a === 'Bilinmeyen') return 1;
        if (b === 'Bilinmeyen') return -1;
        const [dayA, monthA, yearA] = a.split('.');
        const [dayB, monthB, yearB] = b.split('.');
        if (!dayA || !dayB) return 0;
        const dateA = new Date(yearA, monthA - 1, dayA);
        const dateB = new Date(yearB, monthB - 1, dayB);
        return dateB - dateA;
      });

      let html = '';
      sortedDates.forEach(date => {
        const daySales = salesByDate[date];
        const dayTotal = daySales.reduce((sum, sale) => sum + parseFloat(sale.total_amount || 0), 0);
        
        html += `
          <div class="date-group">
            <div class="date-header">
              <div>
                <h2 class="date-title">${formatDateDisplay(date)}</h2>
                <p class="date-subtitle">${daySales.length} satÄ±ÅŸ â€¢ Toplam: â‚º${dayTotal.toFixed(2)}</p>
              </div>
            </div>
            <div class="sales-grid">
              ${daySales.map(sale => {
                const itemsHtml = sale.items && sale.items.length > 0
                  ? sale.items.map(item => `
                    <div class="sale-item">
                      <span class="item-name">${item.product_name}</span>
                      <span class="item-quantity">x${item.quantity}</span>
                      ${item.isGift ? '<span class="gift-badge">Ä°KRAM</span>' : ''}
                    </div>
                  `).join('')
                  : `<div class="sale-item"><span class="item-name">${sale.itemsText || 'ÃœrÃ¼n bulunamadÄ±'}</span></div>`;
                
                return `
                <div class="sale-card">
                  <div class="sale-header">
                    <div class="sale-info">
                      <h3 class="sale-id">SatÄ±ÅŸ #${sale.sale_id || sale.id}</h3>
                      <p class="sale-time">${sale.sale_time || ''}</p>
                      <div class="sale-badges">
                        <span class="badge badge-${sale.payment_method === 'Nakit' ? 'cash' : 'card'}">
                          ${sale.payment_method === 'Nakit' ? 'ğŸ’µ Nakit' : 'ğŸ’³ Kart'}
                        </span>
                        ${sale.staff_name ? `<span class="badge badge-staff">ğŸ‘¤ ${sale.staff_name}</span>` : ''}
                        ${sale.table_name ? `<span class="badge badge-table">ğŸª‘ ${sale.table_name}${sale.table_type ? ` (${sale.table_type})` : ''}</span>` : ''}
                      </div>
                    </div>
                    <div class="sale-total">
                      <p class="total-label">TOPLAM</p>
                      <p class="total-amount">â‚º${parseFloat(sale.total_amount || 0).toFixed(2)}</p>
                    </div>
                  </div>
                  <div class="sale-items">
                    <p class="items-label">ÃœrÃ¼nler:</p>
                    <div class="items-list">
                      ${itemsHtml}
                    </div>
                  </div>
                </div>
              `;
              }).join('')}
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    // Ä°statistikleri gÃ¼ncelle
    function updateStats(sales) {
      const today = new Date().toLocaleDateString('tr-TR');
      const todaySales = sales.filter(s => s.sale_date === today);
      const todayRevenue = todaySales.reduce((sum, s) => sum + parseFloat(s.total_amount || 0), 0);
      
      const statsGrid = document.getElementById('statsGrid');
      if (!statsGrid) return;
      
      statsGrid.innerHTML = `
        <div class="stat-card stat-card-green">
          <div class="stat-icon">ğŸ’°</div>
          <div class="stat-content">
            <h3>GÃ¼nlÃ¼k Ciro</h3>
            <div class="stat-value">â‚º${todayRevenue.toFixed(2)}</div>
          </div>
        </div>
        <div class="stat-card stat-card-purple">
          <div class="stat-icon">ğŸ“Š</div>
          <div class="stat-content">
            <h3>BugÃ¼nkÃ¼ SatÄ±ÅŸ</h3>
            <div class="stat-value">${todaySales.length}</div>
          </div>
        </div>
      `;
    }

    function showLoading(show) {
      const loader = document.getElementById('loader');
      if (loader) {
        loader.style.display = show ? 'flex' : 'none';
      }
    }

    // Aktif sekme deÄŸiÅŸtir
    function setActiveTab(tab) {
      activeTab = tab;
      renderCurrentView();
      updateTabButtons();
    }

    // Tab butonlarÄ±nÄ± gÃ¼ncelle
    function updateTabButtons() {
      const buttons = document.querySelectorAll('.tab-btn');
      buttons.forEach(btn => {
        if (btn.dataset.tab === activeTab) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });
    }

    // Mevcut gÃ¶rÃ¼nÃ¼mÃ¼ render et
    function renderCurrentView() {
      if (activeTab === 'sales') {
        renderSales(allSales);
      } else if (activeTab === 'reports') {
        renderReports();
      } else if (activeTab === 'staff') {
        renderStaffDetails();
      }
    }

    // Tarih filtresine gÃ¶re satÄ±ÅŸlarÄ± filtrele
    function filterSalesByDate(sales) {
      const now = new Date();
      now.setHours(23, 59, 59, 999);
      
      if (reportDateFilter === 'week') {
        const weekAgo = new Date(now);
        weekAgo.setDate(weekAgo.getDate() - 7);
        weekAgo.setHours(0, 0, 0, 0);
        
        return sales.filter(sale => {
          if (!sale.sale_date || sale.sale_date === 'Bilinmeyen') return false;
          const [day, month, year] = sale.sale_date.split('.');
          if (!day || !month || !year) return false;
          const saleDate = new Date(year, month - 1, day);
          saleDate.setHours(0, 0, 0, 0);
          return saleDate >= weekAgo && saleDate <= now;
        });
      } else if (reportDateFilter === 'month') {
        const monthAgo = new Date(now);
        monthAgo.setMonth(monthAgo.getMonth() - 1);
        monthAgo.setHours(0, 0, 0, 0);
        
        return sales.filter(sale => {
          if (!sale.sale_date || sale.sale_date === 'Bilinmeyen') return false;
          const [day, month, year] = sale.sale_date.split('.');
          if (!day || !month || !year) return false;
          const saleDate = new Date(year, month - 1, day);
          saleDate.setHours(0, 0, 0, 0);
          return saleDate >= monthAgo && saleDate <= now;
        });
      }
      
      return sales; // 'all' iÃ§in tÃ¼m satÄ±ÅŸlar
    }

    // Tarih filtresini deÄŸiÅŸtir
    function setReportDateFilter(filter) {
      reportDateFilter = filter;
      renderReports();
    }

    // Tarih filtresi modal'Ä±nÄ± aÃ§/kapa
    function toggleDateFilterModal(event) {
      if (event) {
        event.stopPropagation();
      }
      const modal = document.getElementById('dateFilterModal');
      if (modal) {
        const isOpen = modal.classList.contains('show');
        // Ã–nce tÃ¼m modal'larÄ± kapat
        document.querySelectorAll('.date-filter-modal').forEach(m => m.classList.remove('show'));
        // Sonra bu modal'Ä± aÃ§/kapa
        if (!isOpen) {
          modal.classList.add('show');
        }
      }
    }

    // Tarih filtresi modal'Ä±nÄ± kapat
    function closeDateFilterModal() {
      const modal = document.getElementById('dateFilterModal');
      if (modal) {
        modal.classList.remove('show');
      }
    }

    // DetaylÄ± Raporlama render et
    function renderReports() {
      const container = document.getElementById('salesContainer');
      if (!container) return;

      let reportSales = allSales.filter(sale => !sale.isExpense);
      reportSales = filterSalesByDate(reportSales);

      if (reportSales.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">ğŸ“Š</div>
            <h3>HenÃ¼z veri yok</h3>
            <p>SatÄ±ÅŸ yapÄ±ldÄ±kÃ§a raporlar oluÅŸturulacak</p>
          </div>
        `;
        return;
      }

      // ÃœrÃ¼n istatistiklerini hesapla - Firebase'den gelen gerÃ§ek satÄ±ÅŸ detaylarÄ±nÄ± kullan
      const productStats = {};
      
      reportSales.forEach(sale => {
        let itemsArray = [];
        
        if (sale.items_array && Array.isArray(sale.items_array)) {
          itemsArray = sale.items_array;
        } else if (sale.items) {
          const items = sale.items.split(', ');
          itemsArray = items.map(item => {
            const match = item.match(/(.+) x(\d+)/);
            if (match) {
              const [, productName, quantity] = match;
              const isGift = item.includes('(Ä°KRAM)');
              return {
                product_name: productName.replace(' (Ä°KRAM)', ''),
                quantity: parseInt(quantity),
                price: 0,
                isGift: isGift
              };
            }
            return null;
          }).filter(Boolean);
        }
        
        itemsArray.forEach(item => {
          if (!item || !item.product_name) return;
          
          const productName = item.product_name;
          const quantity = item.quantity || 1;
          const isGift = item.isGift || false;
          
          if (!productStats[productName]) {
            productStats[productName] = { 
              count: 0, 
              revenue: 0,
              price: item.price || 0
            };
          }
          
          productStats[productName].count += quantity;
          
          if (!isGift && item.price) {
            productStats[productName].revenue += item.price * quantity;
            if (productStats[productName].price === 0) {
              productStats[productName].price = item.price;
            }
          } else if (!isGift && !item.price && sale.total_amount) {
            const saleTotal = parseFloat(sale.total_amount);
            const nonGiftItems = itemsArray.filter(i => !i.isGift);
            const totalNonGiftQuantity = nonGiftItems.reduce((sum, i) => sum + (i.quantity || 1), 0);
            
            if (totalNonGiftQuantity > 0) {
              productStats[productName].revenue += (saleTotal / totalNonGiftQuantity) * quantity;
            }
          }
        });
      });

      const productEntries = Object.entries(productStats);
      const topProductsByCount = [...productEntries]
        .sort(([, a], [, b]) => b.count - a.count)
        .slice(0, 5);
      const bottomProductsByCount = [...productEntries]
        .sort(([, a], [, b]) => a.count - b.count)
        .slice(0, 5);
      const topProductsByRevenue = [...productEntries]
        .sort(([, a], [, b]) => b.revenue - a.revenue)
        .slice(0, 5);
      const bottomProductsByRevenue = [...productEntries]
        .sort(([, a], [, b]) => a.revenue - b.revenue)
        .slice(0, 5);

      const paymentMethods = {};
      reportSales.forEach(sale => {
        if (!paymentMethods[sale.payment_method]) {
          paymentMethods[sale.payment_method] = { count: 0, total: 0 };
        }
        paymentMethods[sale.payment_method].count++;
        paymentMethods[sale.payment_method].total += parseFloat(sale.total_amount);
      });

      const totalRevenue = reportSales.reduce((sum, sale) => sum + parseFloat(sale.total_amount), 0);

      const filterLabels = {
        'all': 'TÃ¼m Zamanlar',
        'week': 'Son 1 Hafta',
        'month': 'Son 1 Ay'
      };

      let html = `
        <div class="reports-container">
          <div class="reports-header">
            <h2 class="reports-title">ğŸ“Š DetaylÄ± Raporlama</h2>
            <div class="date-filter-wrapper">
              <button class="date-filter-trigger" onclick="toggleDateFilterModal(event)">
                <span>ğŸ“…</span>
                <span>${filterLabels[reportDateFilter]}</span>
                <span class="date-filter-arrow">â–¼</span>
              </button>
              <div id="dateFilterModal" class="date-filter-modal">
                <div class="date-filter-modal-content">
                  <div class="date-filter-option ${reportDateFilter === 'week' ? 'active' : ''}" onclick="setReportDateFilter('week'); closeDateFilterModal();">
                    <span class="date-filter-icon">ğŸ“†</span>
                    <span>Son 1 Hafta</span>
                  </div>
                  <div class="date-filter-option ${reportDateFilter === 'month' ? 'active' : ''}" onclick="setReportDateFilter('month'); closeDateFilterModal();">
                    <span class="date-filter-icon">ğŸ“…</span>
                    <span>Son 1 Ay</span>
                  </div>
                  <div class="date-filter-option ${reportDateFilter === 'all' ? 'active' : ''}" onclick="setReportDateFilter('all'); closeDateFilterModal();">
                    <span class="date-filter-icon">ğŸ“Š</span>
                    <span>TÃ¼m Zamanlar</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="stats-grid">
            <div class="stat-card stat-card-green">
              <div class="stat-icon">ğŸ’°</div>
              <div class="stat-content">
                <h3>Toplam Ciro</h3>
                <div class="stat-value">â‚º${totalRevenue.toFixed(2)}</div>
              </div>
            </div>
            <div class="stat-card stat-card-blue">
              <div class="stat-icon">ğŸ“¦</div>
              <div class="stat-content">
                <h3>Toplam SatÄ±ÅŸ</h3>
                <div class="stat-value">${reportSales.length}</div>
              </div>
            </div>
            <div class="stat-card stat-card-purple">
              <div class="stat-icon">ğŸ“Š</div>
              <div class="stat-content">
                <h3>Ortalama Sepet</h3>
                <div class="stat-value">â‚º${(reportSales.length > 0 ? (totalRevenue / reportSales.length) : 0).toFixed(2)}</div>
              </div>
            </div>
            <div class="stat-card stat-card-orange">
              <div class="stat-icon">ğŸ“ˆ</div>
              <div class="stat-content">
                <h3>En YÃ¼ksek SatÄ±ÅŸ</h3>
                <div class="stat-value">â‚º${(reportSales.length > 0 ? Math.max(...reportSales.map(s => parseFloat(s.total_amount))) : 0).toFixed(2)}</div>
              </div>
            </div>
          </div>

          <div class="reports-grid">
            <div class="report-card report-card-top-sold">
              <h3 class="report-card-title">ğŸ† En Ã‡ok SatÄ±lan ÃœrÃ¼nler</h3>
              <div class="product-list">
                ${topProductsByCount.length > 0 ? topProductsByCount.map(([product, stats], index) => `
                  <div class="product-item">
                    <div class="product-rank">${index + 1}</div>
                    <div class="product-info">
                      <div class="product-name">${product}</div>
                      <div class="product-details">
                        <span>${stats.count} adet</span>
                        ${stats.price > 0 ? `<span>â€¢ Birim: â‚º${stats.price.toFixed(2)}</span>` : ''}
                      </div>
                      <div class="product-revenue">Toplam: â‚º${stats.revenue.toFixed(2)}</div>
                    </div>
                  </div>
                `).join('') : '<p class="no-data">Veri yok</p>'}
              </div>
            </div>

            <div class="report-card report-card-top-earning">
              <h3 class="report-card-title">ğŸ’µ En Ã‡ok KazandÄ±ran ÃœrÃ¼nler</h3>
              <div class="product-list">
                ${topProductsByRevenue.length > 0 ? topProductsByRevenue.map(([product, stats], index) => `
                  <div class="product-item">
                    <div class="product-rank">${index + 1}</div>
                    <div class="product-info">
                      <div class="product-name">${product}</div>
                      <div class="product-revenue-large">â‚º${stats.revenue.toFixed(2)}</div>
                      <div class="product-details">
                        <span>${stats.count} adet</span>
                        ${stats.price > 0 ? `<span>â€¢ Birim: â‚º${stats.price.toFixed(2)}</span>` : ''}
                      </div>
                    </div>
                  </div>
                `).join('') : '<p class="no-data">Veri yok</p>'}
              </div>
            </div>

            <div class="report-card report-card-bottom-sold">
              <h3 class="report-card-title">ğŸ“‰ En Az SatÄ±lan ÃœrÃ¼nler</h3>
              <div class="product-list">
                ${bottomProductsByCount.length > 0 ? bottomProductsByCount.map(([product, stats], index) => `
                  <div class="product-item">
                    <div class="product-rank">${index + 1}</div>
                    <div class="product-info">
                      <div class="product-name">${product}</div>
                      <div class="product-details">
                        <span>${stats.count} adet</span>
                        ${stats.price > 0 ? `<span>â€¢ Birim: â‚º${stats.price.toFixed(2)}</span>` : ''}
                      </div>
                      <div class="product-revenue">Toplam: â‚º${stats.revenue.toFixed(2)}</div>
                    </div>
                  </div>
                `).join('') : '<p class="no-data">Veri yok</p>'}
              </div>
            </div>

            <div class="report-card report-card-bottom-earning">
              <h3 class="report-card-title">ğŸ’¸ En Az KazandÄ±ran ÃœrÃ¼nler</h3>
              <div class="product-list">
                ${bottomProductsByRevenue.length > 0 ? bottomProductsByRevenue.map(([product, stats], index) => `
                  <div class="product-item">
                    <div class="product-rank">${index + 1}</div>
                    <div class="product-info">
                      <div class="product-name">${product}</div>
                      <div class="product-revenue-large">â‚º${stats.revenue.toFixed(2)}</div>
                      <div class="product-details">
                        <span>${stats.count} adet</span>
                        ${stats.price > 0 ? `<span>â€¢ Birim: â‚º${stats.price.toFixed(2)}</span>` : ''}
                      </div>
                    </div>
                  </div>
                `).join('') : '<p class="no-data">Veri yok</p>'}
              </div>
            </div>
          </div>

          <div class="report-card">
            <h3 class="report-card-title">ğŸ’³ Ã–deme YÃ¶ntemleri</h3>
            <div class="payment-methods">
              ${Object.entries(paymentMethods).map(([method, data]) => `
                <div class="payment-method-item">
                  <div class="payment-method-header">
                    <span class="payment-method-name">${method}</span>
                    <span class="payment-method-count">${data.count} satÄ±ÅŸ (${reportSales.length > 0 ? ((data.count / reportSales.length) * 100).toFixed(1) : '0'}%)</span>
                  </div>
                  <div class="payment-progress-bar">
                    <div class="payment-progress-fill" style="width: ${reportSales.length > 0 ? (data.count / reportSales.length) * 100 : 0}%"></div>
                  </div>
                  <div class="payment-total">Toplam: â‚º${data.total.toFixed(2)}</div>
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      `;

      container.innerHTML = html;
    }

    // Personel DetaylarÄ± render et
    function renderStaffDetails() {
      const container = document.getElementById('salesContainer');
      if (!container) return;

      const reportSales = allSales.filter(sale => !sale.isExpense);
      const staffStats = {};
      
      reportSales.forEach(sale => {
        if (sale.items_array && Array.isArray(sale.items_array) && sale.items_array.length > 0) {
          const staffInThisSale = new Set();
          
          sale.items_array.forEach(item => {
            const itemStaffName = item.staff_name || sale.staff_name;
            
            if (!itemStaffName) return;
            
            staffInThisSale.add(itemStaffName);
            
            if (!staffStats[itemStaffName]) {
              staffStats[itemStaffName] = {
                name: itemStaffName,
                totalRevenue: 0,
                totalSales: 0,
                products: {},
                averageSale: 0,
                totalItemsSold: 0,
                totalGiftItems: 0
              };
            }
            
            const productName = item.product_name;
            const quantity = item.quantity || 0;
            const price = parseFloat(item.price || 0);
            const isGift = item.isGift || false;
            
            if (!isGift) {
              staffStats[itemStaffName].totalRevenue += (price * quantity);
            }
            
            if (!staffStats[itemStaffName].products[productName]) {
              staffStats[itemStaffName].products[productName] = {
                count: 0,
                revenue: 0
              };
            }
            
            staffStats[itemStaffName].products[productName].count += quantity;
            if (!isGift) {
              staffStats[itemStaffName].products[productName].revenue += (price * quantity);
            }
            
            staffStats[itemStaffName].totalItemsSold += quantity;
            if (isGift) {
              staffStats[itemStaffName].totalGiftItems += quantity;
            }
          });
          
          staffInThisSale.forEach(staffName => {
            if (staffStats[staffName]) {
              staffStats[staffName].totalSales += 1;
            }
          });
        } else if (sale.staff_name) {
          if (!staffStats[sale.staff_name]) {
            staffStats[sale.staff_name] = {
              name: sale.staff_name,
              totalRevenue: 0,
              totalSales: 0,
              products: {},
              averageSale: 0,
              totalItemsSold: 0,
              totalGiftItems: 0
            };
          }
          
          staffStats[sale.staff_name].totalRevenue += parseFloat(sale.total_amount);
          staffStats[sale.staff_name].totalSales += 1;
        }
      });
      
      Object.keys(staffStats).forEach(staffName => {
        const stats = staffStats[staffName];
        stats.averageSale = stats.totalSales > 0 ? stats.totalRevenue / stats.totalSales : 0;
      });
      
      const sortedStaff = Object.values(staffStats).sort((a, b) => b.totalRevenue - a.totalRevenue);
      
      if (sortedStaff.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">ğŸ‘¥</div>
            <h3>Personel satÄ±ÅŸ verisi bulunamadÄ±</h3>
            <p>HenÃ¼z personel satÄ±ÅŸ verisi yok</p>
          </div>
        `;
        return;
      }

      let html = `
        <div class="staff-container">
          <h2 class="staff-title">ğŸ‘¥ Personel DetaylarÄ±</h2>
          <div class="staff-grid">
            ${sortedStaff.map((staff, index) => {
              const topProducts = Object.entries(staff.products)
                .map(([name, data]) => [name, typeof data === 'object' ? data.count : data])
                .sort(([, a], [, b]) => b - a)
                .slice(0, 3);
              
              return `
                <div class="staff-card">
                  <div class="staff-header">
                    <div class="staff-avatar ${index === 0 ? 'gold' : index === 1 ? 'silver' : index === 2 ? 'bronze' : ''}">
                      ${index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : 'ğŸ‘¤'}
                    </div>
                    <div class="staff-info">
                      <h3 class="staff-name">${staff.name}</h3>
                      <p class="staff-sales-count">${staff.totalSales} satÄ±ÅŸ yaptÄ±</p>
                    </div>
                  </div>
                  
                  <div class="staff-stats-grid">
                    <div class="staff-stat-card green">
                      <p class="staff-stat-label">Toplam Ciro</p>
                      <p class="staff-stat-value">â‚º${staff.totalRevenue.toFixed(2)}</p>
                    </div>
                    <div class="staff-stat-card blue">
                      <p class="staff-stat-label">Ortalama SatÄ±ÅŸ</p>
                      <p class="staff-stat-value">â‚º${staff.averageSale.toFixed(2)}</p>
                    </div>
                    <div class="staff-stat-card purple">
                      <p class="staff-stat-label">Toplam SatÄ±ÅŸ</p>
                      <p class="staff-stat-value">${staff.totalSales}</p>
                    </div>
                    <div class="staff-stat-card orange">
                      <p class="staff-stat-label">Toplam ÃœrÃ¼n</p>
                      <p class="staff-stat-value">${staff.totalItemsSold || 0}</p>
                      ${staff.totalGiftItems > 0 ? `<p class="staff-stat-sub">(${staff.totalGiftItems} ikram)</p>` : ''}
                    </div>
                  </div>
                  
                  ${topProducts.length > 0 ? `
                    <div class="staff-top-products">
                      <h4 class="staff-top-products-title">En Ã‡ok SattÄ±ÄŸÄ± ÃœrÃ¼nler</h4>
                      <div class="staff-products-list">
                        ${topProducts.map(([productName, countOrData], idx) => {
                          const productData = typeof countOrData === 'object' ? countOrData : { count: countOrData, revenue: 0 };
                          const count = productData.count || 0;
                          const revenue = productData.revenue || 0;
                          
                          return `
                            <div class="staff-product-item">
                              <div class="staff-product-rank">${idx + 1}</div>
                              <div class="staff-product-info">
                                <span class="staff-product-name">${productName}</span>
                                ${revenue > 0 ? `<span class="staff-product-revenue">â‚º${revenue.toFixed(2)} kazandÄ±rdÄ±</span>` : ''}
                              </div>
                              <span class="staff-product-count">${count} adet</span>
                            </div>
                          `;
                        }).join('')}
                      </div>
                    </div>
                  ` : ''}
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;

      container.innerHTML = html;
    }

    // Modal dÄ±ÅŸÄ±na tÄ±klanÄ±nca kapat - sayfa yÃ¼klendiÄŸinde ekle
    function setupDateFilterModal() {
      document.addEventListener('click', function(event) {
        const modal = document.getElementById('dateFilterModal');
        const trigger = event.target.closest('.date-filter-trigger');
        const wrapper = event.target.closest('.date-filter-wrapper');
        
        if (modal && !wrapper) {
          modal.classList.remove('show');
        }
      });
    }

    // Global fonksiyonlar
    window.verifyPin = verifyPin;
    window.loadSales = loadSales;
    window.setActiveTab = setActiveTab;
    window.setReportDateFilter = setReportDateFilter;
    window.toggleDateFilterModal = toggleDateFilterModal;
    window.closeDateFilterModal = closeDateFilterModal;
    window.logout = function() {
      sessionStorage.removeItem('adminAuthenticated');
      isAuthenticated = false;
      if (realtimeUnsubscribe) {
        realtimeUnsubscribe();
        realtimeUnsubscribe = null;
      }
      showLogin();
    };

    // Sayfa yÃ¼klendiÄŸinde modal event listener'Ä± ekle
    window.addEventListener('load', function() {
      setupDateFilterModal();
    });
  </script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      width: 100%;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: #f5f7fa;
      min-height: 100vh;
      padding: 10px;
      color: #2c3e50;
      width: 100%;
      max-width: 100vw;
    }

    .container {
      max-width: 100%;
      width: 100%;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border: 1px solid #e1e8ed;
      animation: fadeIn 0.5s ease;
      overflow-x: hidden;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .header {
      text-align: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #e1e8ed;
      position: relative;
    }

    .header h1 {
      color: #2c3e50;
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 5px;
      letter-spacing: -0.3px;
    }

    .header p {
      color: #7f8c8d;
      font-size: 13px;
      font-weight: 400;
    }

    /* Login Section */
    .pin-section {
      background: #ffffff;
      padding: 30px 20px;
      border-radius: 8px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border: 1px solid #e1e8ed;
    }

    .pin-section h2 {
      color: #2c3e50;
      font-size: 22px;
      margin-bottom: 20px;
      font-weight: 600;
    }

    .pin-input {
      padding: 16px 20px;
      font-size: 18px;
      border: 2px solid #667eea;
      border-radius: 12px;
      width: 100%;
      max-width: 280px;
      text-align: center;
      margin: 10px auto;
      font-weight: 600;
      letter-spacing: 4px;
      transition: all 0.3s ease;
      display: block;
      box-sizing: border-box;
    }

    .pin-input:focus {
      outline: none;
      border-color: #764ba2;
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
      transform: scale(1.02);
    }

    .pin-btn {
      padding: 16px 32px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      margin: 10px auto;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      display: block;
      min-width: 200px;
    }

    .pin-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }

    .pin-btn:active {
      transform: translateY(0);
    }

    /* Dashboard */
    .dashboard {
      display: none;
    }

    .dashboard.active {
      display: block;
    }

    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      flex-wrap: wrap;
      gap: 10px;
      width: 100%;
    }

    .dashboard-header > div {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      width: 100%;
    }

    .dashboard-title {
      font-size: 20px;
      font-weight: 600;
      color: #2c3e50;
    }

    .refresh-btn {
      padding: 10px 16px;
      background: #27ae60;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(39, 174, 96, 0.2);
      display: flex;
      align-items: center;
      gap: 6px;
      min-height: 44px;
    }

    .refresh-btn:hover {
      background: #229954;
      box-shadow: 0 4px 8px rgba(39, 174, 96, 0.3);
    }

    .logout-btn {
      padding: 10px 16px;
      background: #e74c3c;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(231, 76, 60, 0.2);
      min-height: 44px;
    }

    .logout-btn:hover {
      background: #c0392b;
      box-shadow: 0 4px 8px rgba(231, 76, 60, 0.3);
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 20px;
      width: 100%;
      max-width: 100%;
    }

    .stat-card {
      background: white;
      padding: 16px;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      display: flex;
      align-items: center;
      gap: 12px;
      transition: all 0.2s ease;
      border: 1px solid #e1e8ed;
      width: 100%;
      min-width: 0;
      overflow: hidden;
    }

    .stat-card:hover {
      box-shadow: 0 2px 6px rgba(0,0,0,0.12);
      border-color: #cbd5e0;
    }

    .stat-card-green {
      border-left: 3px solid #27ae60;
    }

    .stat-card-blue {
      border-left: 3px solid #3498db;
    }

    .stat-card-purple {
      border-left: 3px solid #9b59b6;
    }

    .stat-card-orange {
      border-left: 3px solid #f39c12;
    }

    .stat-card-pink {
      border-left: 3px solid #e91e63;
    }

    .stat-card-cyan {
      border-left: 3px solid #16a085;
    }

    .stat-icon {
      font-size: 28px;
      line-height: 1;
      flex-shrink: 0;
    }

    .stat-content {
      flex: 1;
      min-width: 0;
    }

    .stat-content h3 {
      font-size: 11px;
      color: #666;
      margin-bottom: 4px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .stat-value {
      font-size: 18px;
      font-weight: 800;
      color: #333;
      word-break: break-word;
    }

    /* Sales Container */
    #salesContainer {
      min-height: 200px;
    }

    .date-group {
      margin-bottom: 20px;
    }

    .date-header {
      background: #ffffff;
      color: #2c3e50;
      padding: 12px 16px;
      border-radius: 6px;
      margin-bottom: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      border: 1px solid #e1e8ed;
      border-left: 3px solid #3498db;
    }

    .date-title {
      font-size: 16px;
      font-weight: 800;
      margin-bottom: 4px;
    }

    .date-subtitle {
      font-size: 12px;
      opacity: 0.9;
      font-weight: 500;
    }

    .sales-grid {
      display: grid;
      gap: 20px;
    }

    .sale-card {
      background: white;
      border-radius: 6px;
      padding: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      border: 1px solid #e1e8ed;
      transition: all 0.2s ease;
    }

    .sale-card:hover {
      box-shadow: 0 2px 6px rgba(0,0,0,0.12);
    }

    .sale-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }

    .sale-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid #f0f0f0;
    }

    .sale-info {
      flex: 1;
      min-width: 0;
    }

    .sale-id {
      font-size: 16px;
      font-weight: 800;
      color: #333;
      margin-bottom: 4px;
    }

    .sale-time {
      color: #666;
      font-size: 12px;
      margin-bottom: 8px;
    }

    .sale-badges {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      width: 100%;
    }

    .badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .badge-cash {
      background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
      color: #2e7d32;
    }

    .badge-card {
      background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
      color: #1565c0;
    }

    .badge-staff {
      background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
      color: #7b1fa2;
    }

    .badge-table {
      background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
      color: #e65100;
    }

    .sale-total {
      text-align: right;
      min-width: 0;
      flex-shrink: 0;
    }

    .total-label {
      font-size: 12px;
      color: #666;
      font-weight: 700;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .total-amount {
      font-size: 22px;
      font-weight: 600;
      color: #2c3e50;
    }

    .sale-items {
      margin-top: 20px;
    }

    .items-label {
      font-size: 13px;
      color: #666;
      font-weight: 700;
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .items-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      width: 100%;
    }

    .sale-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 14px;
      background: #f5f5f5;
      border-radius: 8px;
      font-size: 14px;
    }

    .item-name {
      font-weight: 600;
      color: #333;
    }

    .item-quantity {
      color: #666;
      font-weight: 500;
    }

    .gift-badge {
      background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
      color: white;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 80px 20px;
    }

    .empty-icon {
      font-size: 80px;
      margin-bottom: 20px;
    }

    .empty-state h3 {
      font-size: 24px;
      color: #333;
      margin-bottom: 10px;
      font-weight: 700;
    }

    .empty-state p {
      color: #666;
      font-size: 16px;
    }

    /* Error State */
    .error-card {
      text-align: center;
      padding: 60px 20px;
      background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
      border-radius: 16px;
      border: 2px solid #f44336;
    }

    .error-icon {
      font-size: 60px;
      margin-bottom: 20px;
    }

    .error-card h3 {
      font-size: 24px;
      color: #d32f2f;
      margin-bottom: 10px;
      font-weight: 700;
    }

    .error-card p {
      color: #666;
      margin-bottom: 20px;
    }

    .retry-btn {
      padding: 12px 24px;
      background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .retry-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(244, 67, 54, 0.4);
    }

    /* Loader */
    #loader {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      z-index: 9999;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }

    .loader-spinner {
      width: 60px;
      height: 60px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loader-text {
      font-size: 18px;
      color: #667eea;
      font-weight: 600;
    }

    /* Tab ButonlarÄ± */
    .tab-buttons {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-bottom: 20px;
      margin-top: 0;
      width: 100%;
      max-width: 100%;
    }

    .tab-btn {
      padding: 12px 4px;
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      color: #666;
      min-height: 60px;
      width: 100%;
      min-width: 0;
      box-sizing: border-box;
    }

    .tab-btn span {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }

    .tab-btn:hover {
      border-color: #667eea;
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
    }

    .tab-btn.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-color: transparent;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    /* Reports Styles */
    .reports-container {
      padding: 20px 0;
    }

    .reports-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      flex-wrap: wrap;
      gap: 15px;
      width: 100%;
    }

    .reports-title {
      font-size: 24px;
      font-weight: 600;
      color: #2c3e50;
      margin: 0;
    }

    .date-filter-wrapper {
      position: relative;
    }

    .date-filter-trigger {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: white;
      border: 1px solid #cbd5e0;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      color: #2c3e50;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      white-space: nowrap;
    }

    .date-filter-trigger:hover {
      border-color: #3498db;
      color: #3498db;
      box-shadow: 0 2px 4px rgba(52, 152, 219, 0.15);
    }

    .date-filter-arrow {
      font-size: 10px;
      transition: transform 0.3s ease;
    }

    .date-filter-trigger:hover .date-filter-arrow {
      transform: translateY(2px);
    }

    .date-filter-modal {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
      border: 1px solid #e0e0e0;
      min-width: 200px;
      z-index: 10000;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      overflow: hidden;
      pointer-events: none;
    }

    .date-filter-modal.show {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
      pointer-events: auto;
    }

    .date-filter-modal-content {
      padding: 8px;
    }

    .date-filter-option {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      color: #666;
      font-weight: 500;
      font-size: 14px;
    }

    .date-filter-option:hover {
      background: #f5f5f5;
      color: #667eea;
    }

    .date-filter-option.active {
      background: #e8f4f8;
      color: #3498db;
      font-weight: 600;
    }

    .date-filter-icon {
      font-size: 18px;
      width: 24px;
      text-align: center;
    }

    .reports-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      grid-template-rows: auto auto;
      gap: 20px;
      margin-bottom: 30px;
      align-items: stretch;
    }

    .report-card {
      background: white;
      border-radius: 18px;
      padding: 20px 20px 18px 20px;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.12);
      border: 1px solid rgba(148, 163, 184, 0.45);
      display: flex;
      flex-direction: column;
      min-height: 220px;
    }

    .report-card-title {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 12px;
      color: #0f172a;
      letter-spacing: 0.02em;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .report-card-title::after {
      content: '';
      flex: 1;
      margin-left: 10px;
      height: 2px;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(148, 163, 184, 0.6), rgba(209, 213, 219, 0.05));
    }

    .report-card-top-sold {
      border-top: 3px solid #22c55e;
    }

    .report-card-top-earning {
      border-top: 3px solid #0ea5e9;
    }

    .report-card-bottom-sold {
      border-top: 3px solid #f97316;
    }

    .report-card-bottom-earning {
      border-top: 3px solid #ef4444;
    }

    .product-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      flex: 1;
      min-height: 0;
    }

    .product-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      background: #f9fafb;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
    }

    .product-rank {
      width: 24px;
      height: 24px;
      border-radius: 999px;
      background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 12px;
      box-shadow: 0 2px 8px rgba(79, 70, 229, 0.45);
      flex-shrink: 0;
    }

    .product-info {
      display: flex;
      flex-direction: column;
      gap: 3px;
      min-width: 0;
    }

    .product-name {
      font-weight: 600;
      color: #111827;
      margin-bottom: 0;
      font-size: 13px;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }

    .product-details {
      font-size: 11px;
      color: #6b7280;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .product-revenue {
      font-size: 12px;
      font-weight: 600;
      color: #15803d;
      margin-top: 2px;
    }

    .product-revenue-large {
      font-size: 14px;
      font-weight: 700;
      color: #0f766e;
      margin: 2px 0;
    }

    .no-data {
      text-align: center;
      color: #999;
      padding: 20px;
    }

    .payment-methods {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .payment-method-item {
      padding: 16px;
      background: #f5f5f5;
      border-radius: 8px;
    }

    .payment-method-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .payment-method-name {
      font-weight: 600;
      color: #333;
    }

    .payment-method-count {
      font-size: 12px;
      color: #666;
    }

    .payment-progress-bar {
      width: 100%;
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 8px;
    }

    .payment-progress-fill {
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      transition: width 0.3s ease;
    }

    .payment-total {
      font-size: 14px;
      font-weight: 600;
      color: #333;
    }

    /* Staff Styles */
    .staff-container {
      padding: 20px 0;
    }

    .staff-title {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 30px;
      color: #2c3e50;
    }

    .staff-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 24px;
    }

    .staff-card {
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      border: 1px solid #e0e0e0;
    }

    .staff-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 2px solid #f0f0f0;
    }

    .staff-avatar {
      width: 64px;
      height: 64px;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .staff-avatar.gold {
      background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
    }

    .staff-avatar.silver {
      background: linear-gradient(135deg, #c0c0c0 0%, #e8e8e8 100%);
    }

    .staff-avatar.bronze {
      background: linear-gradient(135deg, #cd7f32 0%, #daa520 100%);
    }

    .staff-name {
      font-size: 24px;
      font-weight: 800;
      color: #333;
      margin-bottom: 4px;
    }

    .staff-sales-count {
      font-size: 14px;
      color: #666;
    }

    .staff-stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }

    .staff-stat-card {
      padding: 16px;
      border-radius: 12px;
      border: 2px solid;
    }

    .staff-stat-card.green {
      background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
      border-color: #4caf50;
    }

    .staff-stat-card.blue {
      background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
      border-color: #2196f3;
    }

    .staff-stat-card.purple {
      background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
      border-color: #9c27b0;
    }

    .staff-stat-card.orange {
      background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
      border-color: #ff9800;
    }

    .staff-stat-label {
      font-size: 12px;
      font-weight: 600;
      color: #666;
      margin-bottom: 8px;
      text-transform: uppercase;
    }

    .staff-stat-value {
      font-size: 24px;
      font-weight: 800;
      color: #333;
    }

    .staff-stat-sub {
      font-size: 11px;
      color: #999;
      margin-top: 4px;
    }

    .staff-top-products {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 2px solid #f0f0f0;
    }

    .staff-top-products-title {
      font-size: 16px;
      font-weight: 700;
      color: #333;
      margin-bottom: 12px;
    }

    .staff-products-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .staff-product-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px;
      background: #f5f5f5;
      border-radius: 8px;
    }

    .staff-product-rank {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 12px;
      flex-shrink: 0;
    }

    .staff-product-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .staff-product-name {
      font-weight: 600;
      color: #333;
      font-size: 14px;
    }

    .staff-product-revenue {
      font-size: 11px;
      color: #666;
    }

    .staff-product-count {
      font-size: 14px;
      font-weight: 700;
      color: #667eea;
    }

    /* Responsive */
    @media (max-width: 768px) {
      html, body {
        width: 100%;
        max-width: 100vw;
        overflow-x: hidden;
      }

      body {
        padding: 5px;
      }

      .container {
        padding: 12px;
        border-radius: 12px;
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
      }

      .header {
        margin-bottom: 15px;
        padding-bottom: 10px;
      }

      .header h1 {
        font-size: 20px;
      }

      .header p {
        font-size: 11px;
      }

      .dashboard-header {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
      }

      .dashboard-title {
        font-size: 18px;
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
        margin-bottom: 15px;
      }

      .stat-card {
        padding: 10px;
        gap: 8px;
      }

      .stat-icon {
        font-size: 24px;
      }

      .stat-content h3 {
        font-size: 10px;
      }

      .stat-value {
        font-size: 16px;
      }

      .tab-buttons-container {
        padding: 6px;
        margin-bottom: 20px;
      }

      .tab-buttons {
        grid-template-columns: repeat(3, 1fr);
        gap: 4px;
        width: 100%;
      }

      .tab-btn {
        padding: 12px 6px;
        font-size: 11px;
        min-height: 70px;
        width: 100%;
        gap: 6px;
      }

      .tab-btn-icon {
        font-size: 20px;
      }

      .tab-btn-text {
        font-size: 10px;
      }

      .tab-btn span:first-child {
        font-size: 18px;
      }

      .sale-header {
        flex-direction: column;
        width: 100%;
      }

      .sale-total {
        text-align: left;
        width: 100%;
        min-width: 0;
      }

      .sale-card {
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
      }

      .sale-info {
        width: 100%;
      }

      .sale-id {
        font-size: 14px;
      }

      .sale-time {
        font-size: 11px;
      }

      .total-amount {
        font-size: 20px;
      }

      .date-header {
        padding: 10px 12px;
      }

      .date-title {
        font-size: 14px;
      }

      .date-subtitle {
        font-size: 11px;
      }

      .reports-grid {
        grid-template-columns: 1fr;
        gap: 12px;
      }

      .report-card {
        padding: 16px;
      }

      .reports-header {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
        margin-bottom: 20px;
      }

      .reports-title {
        font-size: 20px;
        margin-bottom: 0;
      }

      .date-filter-wrapper {
        width: 100%;
      }

      .date-filter-trigger {
        width: 100%;
        justify-content: space-between;
        padding: 10px 12px;
        font-size: 13px;
      }

      .date-filter-modal {
        right: 0;
        left: 0;
        min-width: auto;
        width: 100%;
      }

      .staff-grid {
        grid-template-columns: 1fr;
        gap: 16px;
      }

      .staff-card {
        padding: 16px;
      }

      .staff-title {
        font-size: 20px;
        margin-bottom: 20px;
      }

      .staff-stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
      }

      .staff-stat-card {
        padding: 12px;
      }

      .staff-stat-value {
        font-size: 18px;
      }

      .refresh-btn, .logout-btn {
        flex: 1;
        font-size: 12px;
        padding: 10px 8px;
        min-width: 0;
        white-space: nowrap;
      }

      .refresh-btn span, .logout-btn span {
        font-size: 14px;
      }

      .date-header {
        width: 100%;
        box-sizing: border-box;
      }

      .sales-grid {
        width: 100%;
      }

      .date-group {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div id="loader">
    <div class="loader-spinner"></div>
    <div class="loader-text">YÃ¼kleniyor...</div>
  </div>

  <div class="container">
    <div class="header">
      <h1>MAKARA Admin Dashboard</h1>
      <p>AnlÄ±k SatÄ±ÅŸ DetaylarÄ± ve Ä°statistikler</p>
    </div>

    <div id="loginSection" class="pin-section">
      <h2>PIN ile GiriÅŸ</h2>
      <input type="password" id="pinInput" class="pin-input" placeholder="PIN Girin" maxlength="10" autofocus>
      <br>
      <button onclick="verifyPin()" class="pin-btn">ğŸ”“ GiriÅŸ Yap</button>
    </div>

    <div id="dashboard" class="dashboard">
      <div class="dashboard-header">
        <h1 class="dashboard-title">ğŸ“Š SatÄ±ÅŸ DetaylarÄ±</h1>
        <div style="display: flex; gap: 12px;">
          <button onclick="loadSales()" class="refresh-btn">
            <span>ğŸ”„</span>
            <span>Yenile</span>
          </button>
          <button onclick="logout()" class="logout-btn">
            <span>ğŸšª</span>
            <span>Ã‡Ä±kÄ±ÅŸ</span>
          </button>
        </div>
      </div>
      
      <!-- Tab ButonlarÄ± - En Ãœstte Modern ve Kurumsal -->
      <div class="tab-buttons-container">
        <div class="tab-buttons">
          <button class="tab-btn" data-tab="sales" onclick="setActiveTab('sales')">
            <div class="tab-btn-icon">ğŸ“‹</div>
            <div class="tab-btn-text">SatÄ±ÅŸ GeÃ§miÅŸi</div>
            <div class="tab-btn-indicator"></div>
          </button>
          <button class="tab-btn active" data-tab="reports" onclick="setActiveTab('reports')">
            <div class="tab-btn-icon">ğŸ“Š</div>
            <div class="tab-btn-text">DetaylÄ± Raporlama</div>
            <div class="tab-btn-indicator"></div>
          </button>
          <button class="tab-btn" data-tab="staff" onclick="setActiveTab('staff')">
            <div class="tab-btn-icon">ğŸ‘¥</div>
            <div class="tab-btn-text">Personel DetaylarÄ±</div>
            <div class="tab-btn-indicator"></div>
          </button>
        </div>
      </div>
      
      <div class="stats-grid" id="statsGrid"></div>
      
      <div id="salesContainer" style="min-height: 200px;"></div>
    </div>
  </div>
</body>
</html>
